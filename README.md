# SliceDB

## Overview

SliceDB is a tools for capturing a database subset and restoring it. It also supports
scrubbing sensive data.

Keywords: Database subset, scrubbing, PostgreSQL

## Basic usage

First, query a database to create a schema file.

```sh
slicedb schema > schema.yml
```

Second, dump a slice:

```sh
slicedb dump --root public.example 'WHERE id IN (7, 56, 234)' < schema.yml > slice.zip
```

Third, restore that slice into another database:

```sh
slicedb restore < slice.zip
```

## Connection

Use the [libpq environment variables](https://www.postgresql.org/docs/current/libpq-envars.html) to configure the connection.

```sh
PGHOST=myhost slicedb schema > slice.yml
```

## Schema

See formats/schema.yml for the JSONSchema of the schema file.

The `schema` command uses foreign keys to infer relationships between tables. It is a suggested starting point.

You may want to prune the slice by removing these relationships. And you may need add relationships that don't explicitly have foreign keys.

You may want to make these edits programmatically to an autogenerated schema file using a tool like jq.

## Transformation

*TODO*

- `alphanumeric` - Replace alphanumeric characters, preserve the type and case of characters.
- `date_year` - Change date by up to one year.
- `geozip` - Replace zip code, preserving the first three digits.
- `given_name` - Replace given name.
- `person_name` - Replace name.
- `surname` - Replace surname.
- `composite` - Parse as a composite, with suboptions.

Replacements are deterministic for a given pepper. By default, this is randomly geneated for a slice.

Transformation may operate an existing slice, or happen during the dump.

You may specify it as `--pepper`. Note that possession of the pepper makes the data guessable.

## Cycles

*TODO*

Tables references may form a cycle only if at least one foreign key in the cycle is deferrable.

That foreign key will be deferred during restore.

## Algorithm

The slicing process works as follows:

1. Starting with the root table, query the physical IDs (ctid) of rows.

2. Add the row IDs to the existing list.

3. For new IDs, process each of the adjacent tables, using them as the current root.

4. Write out the manifest of tables as a ZIP entry.

5. For each table part, query the data, transforming it as necessary, and write it
   to a new ZIP entry.

Do this in parallel, using `pg_export_snapshot()` to guarantee a consistent
snapshot across workers.

## Not supported

- Multiple databases
- Databases other than PostgreSQL

## Data

- Given names: [https://www.ssa.gov/cgi-bin/popularnames.cgi](https://www.ssa.gov/cgi-bin/popularnames.cgi)
- Surnames: [https://raw.githubusercontent.com/fivethirtyeight/data/master/most-common-name/surnames.csv](https://raw.githubusercontent.com/fivethirtyeight/data/master/most-common-name/surnames.csv)
- Zip codes: [https://simplemaps.com/data/us-zips](https://simplemaps.com/data/us-zips)
